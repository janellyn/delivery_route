{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    <a href="{{ url_for('routes.calculate_route') }}" class="btn btn-secondary mt-3">–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —ñ–Ω—à–∏–π –º–∞—Ä—à—Ä—É—Ç</a>
  {% else %}
    <div class="row align-items-start mb-3">
    <div class="col-md-6">
      {% if route_type == 'road' %}
        <h3>–†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç: –¢—ñ–ª—å–∫–∏ –ø–æ –¥–æ—Ä–æ–∑—ñ</h3>
      {% elif route_type == 'sidewalk' %}
        <h3>–†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç: –ü–æ —Ç—Ä–æ—Ç—É–∞—Ä–∞–º —Ç–∞ –ø–æ –¥–æ—Ä–æ–∑—ñ</h3>
      {% else %}
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ä—à—Ä—É—Ç—É</h3>
      {% endif %}
    </div>
  </div>

    <div class="row" style:"flex-wrap:nowrap;">
      <ul class="list-group mb-3" style="width:60%;">
        <li class="list-group-item"><strong>–ó–≤—ñ–¥–∫–∏:</strong> {{ origin }}</li>
        <li class="list-group-item"><strong>–ö—É–¥–∏:</strong> {{ destination }}</li>
        <li class="list-group-item">
          <strong>–ß–∞—Å –≤ –¥–æ—Ä–æ–∑—ñ:</strong>
          {% if duration >= 60 %}
            {{ (duration // 60)|int }} –≥–æ–¥ {{ (duration % 60)|round|int }} —Ö–≤
          {% else %}
            {{ duration|round|int }} —Ö–≤–∏–ª–∏–Ω
          {% endif %}
        </li>
        <li class="list-group-item"><strong>–í—ñ–¥—Å—Ç–∞–Ω—å:</strong> {{ distance }} –∫–º</li>
        <li class="list-group-item"><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑—É–ø–∏–Ω–æ–∫:</strong> {{ stops }}</li>
        <li class="list-group-item"><strong>–ü–æ–≥–æ–¥–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ:</strong> {{ weather }}</li>
        <li class="list-group-item"><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç—ñ:</strong> {{ points | length }}</li>
      </ul>
      {% if routes|length > 1 %}
      <div class="col-md-6" style="width: 40%;">
        <div class="card border-info">
          <div class="card-body py-2">
            <h6 class="text-info">üîÅ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç</h6>
            <p class="mb-1">
              <strong>–ß–∞—Å –≤ –¥–æ—Ä–æ–∑—ñ:</strong>
              {% if routes[1].duration >= 60 %}
                {{ (routes[1].duration // 60)|int }} –≥–æ–¥ {{ (routes[1].duration % 60)|round|int }} —Ö–≤
              {% else %}
                {{ routes[1].duration|round|int }} —Ö–≤
              {% endif %}
            </p>
            <p class="mb-1"><strong>–í—ñ–¥—Å—Ç–∞–Ω—å:</strong> {{ routes[1].distance }} –∫–º</p>
            <p class="mb-0"><strong>–ö–æ–ª—ñ—Ä:</strong> <span style="color: green;">–∑–µ–ª–µ–Ω–∏–π</span></p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <ul class="mb-4"><strong>–ó—É–ø–∏–Ω–∫–∏:</strong>
      {% for point in points %}
        <li>{{ point }}</li>
      {% endfor %}
    </ul>

    {% if traffic_status == 'ok' %}
      <div class="alert alert-success">‚úÖ –ó–∞—Ç–æ—Ä—ñ–≤ –Ω–µ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è.</div>
    {% elif traffic_status == 'warning' %}
      <div class="alert alert-warning">‚ö†Ô∏è –Ñ –∑–∞—Ç–æ—Ä–∏ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç—ñ.</div>
    {% elif traffic_status == 'critical' %}
      <div class="alert alert-danger">‚ùå –°–∏–ª—å–Ω—ñ –∑–∞—Ç–æ—Ä–∏ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç—ñ!</div>
    {% endif %}

    <div id="map" style="height: 450px;" class="my-4 border rounded"></div>

    <a href="{{ url_for('routes.calculate_route') }}" class="btn btn-primary">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –Ω–æ–≤–∏–π –º–∞—Ä—à—Ä—É—Ç</a>

    <script>
      var map = L.map('map').setView([{{ coords[0][1] }}, {{ coords[0][0] }}], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      var coords = {{ coords | tojson }};
      var points = {{ points | tojson }};
      var routes = {{ routes | tojson }};

      coords.forEach(function(coord, index) {
        var lat = coord[1];
        var lon = coord[0];
        var label = (index === 0) ? "<b>–°—Ç–∞—Ä—Ç:</b> " + points[index] :
                    (index === coords.length - 1) ? "<b>–§—ñ–Ω—ñ—à:</b> " + points[index] :
                    "<b>–ó—É–ø–∏–Ω–∫–∞ " + index + ":</b> " + points[index];
        L.marker([lat, lon]).addTo(map).bindPopup(label);
      });

      var colors = ['blue', 'green', 'orange', 'purple'];

      routes.forEach(function(route, i) {
        var polyline = L.polyline(route.geometry, {
          color: colors[i % colors.length],
          weight: 4,
          opacity: (i === 0 ? 0.9 : 0.5),
          dashArray: (i === 0 ? null : "5, 10")
        }).addTo(map);
        polyline.bindPopup("–ú–∞—Ä—à—Ä—É—Ç " + (i+1) + ": " + route.duration + " —Ö–≤, " + route.distance + " –∫–º");
      });

      map.fitBounds(L.featureGroup(routes.map(r => L.polyline(r.geometry))).getBounds());
    </script>

  {% endif %}

</div>
{% endblock %}
